<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chibeki</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body { background: #1F2021; color: white; font-family: -apple-system, sans-serif; }
        
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 52px;
            background: rgba(31, 32, 33, 0.85); backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; z-index: 100; border-bottom: 0.5px solid #2A2B2C;
        }
        
        .logo { height: 32px; width: auto; }
        
        .header-right { display: flex; align-items: center; gap: 16px; }
        
        .header-icon {
            width: 24px; height: 24px; opacity: 0.9; cursor: pointer;
            -webkit-mask-size: contain; mask-size: contain; 
            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            background-color: var(--accent-color);
        }
        
        .header-icon.telegram { -webkit-mask-image: url('https://images.icon-icons.com/4040/PNG/512/telegram_logo_icon_256772.png'); mask-image: url('https://images.icon-icons.com/4040/PNG/512/telegram_logo_icon_256772.png'); }
        .header-icon.chat { -webkit-mask-image: url('https://images.icon-icons.com/2942/PNG/512/chat_icon_183898.png'); mask-image: url('https://images.icon-icons.com/2942/PNG/512/chat_icon_183898.png'); }
        
        .main-content { position: absolute; top: 52px; bottom: 0; left: 0; right: 0; overflow-y: auto; }
        .main-content::-webkit-scrollbar { display: none; }
        
        .main-screen { padding: 16px; }
        
        .section-title { font-size: 17px; font-weight: 600; margin-bottom: 12px; color: #FFFFFF; }
        
        .ideas-container { border-radius: 14px; }
        
        .idea-card {
            border: 1.5px solid #2A2B2C; border-radius: 14px; padding: 16px;
            background: transparent; margin-bottom: 12px;
        }
        
        .idea-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .idea-title { font-size: 16px; font-weight: 600; color: #FFFFFF; flex: 1; }
        .idea-content { font-size: 14px; color: rgba(255, 255, 255, 0.7); line-height: 1.4; margin-bottom: 16px; }
        
        .idea-footer { display: flex; justify-content: space-between; align-items: center; }
        .reaction-container { display: flex; align-items: center; gap: 8px; }
        
        .reaction-btn {
            background: #2A2B2C; border-radius: 19px; padding: 6px 12px;
            display: flex; align-items: center; gap: 4px; cursor: pointer;
            border: none; font-family: inherit; position: relative; overflow: hidden;
        }
        
        .reaction-btn.active { background: var(--accent-color); }
        .reaction-btn.active .reaction-count { color: white; font-weight: 600; }
        
        .reaction-gif { width: 20px; height: 20px; object-fit: contain; }
        .reaction-count { font-size: 14px; color: rgba(255, 255, 255, 0.7); }
        
        .delete-icon {
            width: 18px; height: 18px; margin-left: 8px; opacity: 0.7; cursor: pointer;
            -webkit-mask: url('https://img.icons8.com/?size=100&id=IY5fIbHO723h&format=png&color=000000');
            mask: url('https://img.icons8.com/?size=100&id=IY5fIbHO723h&format=png&color=000000');
            -webkit-mask-size: contain; mask-size: contain; background-color: #ff453a;
        }
        
        .add-idea-btn {
            background: var(--accent-color); color: white; border: none; border-radius: 14px;
            padding: 12px; width: 100%; font-size: 16px; font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; margin-top: 16px;
        }
        
        .add-idea-btn-icon { width: 20px; height: 20px; filter: invert(1); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1F2021; z-index: 1000; display: none; }
        .modal-overlay.active { display: block; }
        
        .modal-header { height: 52px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; }
        .modal-title { font-size: 17px; font-weight: 600; color: #FFFFFF; display: flex; align-items: center; gap: 8px; }
        .modal-title-icon { width: 20px; height: 20px; filter: invert(1); }
        
        .modal-close { width: 24px; height: 24px; opacity: 0.8; cursor: pointer; position: relative; }
        .modal-close::before, .modal-close::after { content: ''; position: absolute; top: 50%; left: 50%; width: 18px; height: 2px; background: white; }
        .modal-close::before { transform: translate(-50%, -50%) rotate(45deg); }
        .modal-close::after { transform: translate(-50%, -50%) rotate(-45deg); }
        
        .modal-content { padding: 20px 16px; }
        
        .input-group { margin-bottom: 16px; }
        .input-label { font-size: 15px; font-weight: 500; color: #FFFFFF; margin-bottom: 8px; }
        .input-field {
            width: 100%; background: transparent; border: 1px solid #353637; border-radius: 10px;
            padding: 12px; font-size: 16px; color: white; font-family: inherit;
        }
        
        .input-field::placeholder { color: rgba(255, 255, 255, 0.3); }
        .input-field:focus { outline: none; border-color: var(--accent-color); }
        
        .char-counter { text-align: right; font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 4px; }
        .char-counter.error { color: #ff453a; }
        
        .modal-btn {
            width: 100%; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 500;
            border: none; cursor: pointer; background: var(--accent-color); color: white;
        }
        
        :root { --accent-color: #007AFF; }
        
        /* Анимация для реакции */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .reaction-btn.pulse { animation: pulse 0.3s ease; }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://i.ibb.co/zTB331HR/image.png" alt="Chibeki" class="logo">
        <div class="header-right">
            <div class="header-icon telegram" onclick="openChannel()"></div>
            <div class="header-icon chat" onclick="openRequestBot()"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="main-screen">
            <div class="section-title">Идеи</div>
            <div class="ideas-container" id="ideasContainer">
                <!-- Идеи будут здесь -->
            </div>
            <button class="add-idea-btn" onclick="openAddIdeaModal()">
                <img src="https://images.icon-icons.com/916/PNG/512/Plus_icon-icons.com_71848.png" 
                     class="add-idea-btn-icon">Закинуть идею
            </button>
        </div>
    </div>

    <!-- Модальное окно добавления идеи -->
    <div class="modal-overlay" id="addIdeaModal">
        <div class="modal-header">
            <div class="modal-title">
                <img src="https://img.icons8.com/?size=100&id=KXtAS0MR3VBG&format=png&color=000000" 
                     class="modal-title-icon">Закинуть идею
            </div>
            <div class="modal-close" onclick="closeAddIdeaModal()"></div>
        </div>
        <div class="modal-content">
            <div class="input-group">
                <div class="input-label">Название</div>
                <input type="text" class="input-field" id="ideaTitle" placeholder="Введи название идейки" maxlength="15">
                <div class="char-counter" id="titleCharCounter">0/15</div>
            </div>
            <div class="input-group">
                <div class="input-label">Твоя идейка</div>
                <textarea class="input-field" id="ideaContent" placeholder="Опиши свою идею" style="min-height: 100px;"></textarea>
            </div>
            <button class="modal-btn" onclick="submitIdea()">Закинуть</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const ADMIN_USERNAMES = ['ya_admin7', 'tmkazavr'];
        
        const firebaseConfig = {
            apiKey: "AIzaSyDrvqEb5GMrWaCLSd3aHEdOQIDA321v_BA",
            authDomain: "chibeki-ideas.firebaseapp.com",
            projectId: "chibeki-ideas",
            storageBucket: "chibeki-ideas.firebasestorage.app",
            messagingSenderId: "31211023786",
            appId: "1:31211023786:web:35343c74dbf73a50f6cfd3"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let ideas = [], currentUser = null, unsubscribeIdeas = null;
        const STATIC_IDEA = {
            title: 'Когда дроп?',
            content: 'Когда новые чибики уже?',
            author: 'Система',
            userId: 'system',
            timestamp: new Date().toISOString(),
            reactions: {}
        };

        function init() {
            tg.ready(); tg.expand();
            tg.setHeaderColor('#1F2021'); tg.setBackgroundColor('#1F2021');
            currentUser = tg.initDataUnsafe?.user;
            
            let accentColor = '#007AFF';
            if (tg.themeParams.accent_text_color) accentColor = tg.themeParams.accent_text_color;
            document.documentElement.style.setProperty('--accent-color', accentColor);
            
            loadIdeas();
        }

        function openChannel() { tg.HapticFeedback.impactOccurred('light'); tg.openTelegramLink('https://t.me/chibeki_official'); }
        function openRequestBot() { tg.HapticFeedback.impactOccurred('light'); tg.openTelegramLink('https://t.me/request_chibeki_bot'); }

        async function loadIdeas() {
            try {
                unsubscribeIdeas = db.collection('ideas').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                    ideas = [STATIC_IDEA];
                    snapshot.forEach(doc => {
                        if (doc.id !== 'static') {
                            const idea = doc.data();
                            idea.id = doc.id;
                            ideas.push(idea);
                        }
                    });
                    renderIdeas();
                });
            } catch(e) { console.error('Error:', e); }
        }

        function renderIdeas() {
            const container = document.getElementById('ideasContainer');
            container.innerHTML = '';
            
            ideas.forEach(idea => {
                const isAdmin = currentUser && ADMIN_USERNAMES.includes(currentUser.username);
                const userId = currentUser?.id?.toString();
                const userLiked = idea.reactions?.like?.users?.includes(userId);
                const isStatic = idea.userId === 'system';
                
                const card = document.createElement('div');
                card.className = 'idea-card';
                card.innerHTML = `
                    <div class="idea-header">
                        <div class="idea-title">${idea.title}</div>
                        ${isAdmin && !isStatic ? `<div class="delete-icon" onclick="deleteIdea('${idea.id}')"></div>` : ''}
                    </div>
                    <div class="idea-content">${idea.content}</div>
                    <div class="idea-footer">
                        <div class="reaction-container">
                            <button class="reaction-btn ${userLiked ? 'active' : ''}" 
                                    onclick="toggleReaction('${isStatic ? 'static' : idea.id}')">
                                <img src="https://stickers.fullyst.com/b9f1c4ec-ff51-507f-a011-b3c035880c92/full/AgADyQcAAuN4BAAB.webp" 
                                     class="reaction-gif">
                                <span class="reaction-count">${idea.reactions?.like?.count || 0}</span>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function toggleReaction(ideaId) {
            if (!currentUser) return tg.showPopup({title:'Ошибка',message:'Нужно войти',buttons:[{type:'ok',text:'Понятно'}]});
            
            tg.HapticFeedback.impactOccurred('medium');
            
            const btn = event.target.closest('.reaction-btn');
            btn.classList.add('pulse');
            setTimeout(() => btn.classList.remove('pulse'), 300);
            
            try {
                const ref = ideaId === 'static' ? db.collection('ideas').doc('static') : db.collection('ideas').doc(ideaId);
                const userId = currentUser.id.toString();
                
                const doc = await ref.get();
                let data = doc.exists ? doc.data() : {reactions: {}};
                if (!data.reactions) data.reactions = {};
                if (!data.reactions.like) data.reactions.like = {count: 0, users: []};
                
                const users = data.reactions.like.users || [];
                const index = users.indexOf(userId);
                
                if (index === -1) {
                    users.push(userId);
                    data.reactions.like.count++;
                } else {
                    users.splice(index, 1);
                    data.reactions.like.count = Math.max(0, data.reactions.like.count - 1);
                }
                
                if (data.reactions.like.count === 0) delete data.reactions.like;
                if (Object.keys(data.reactions).length === 0) delete data.reactions;
                
                await ref.set(data, { merge: true });
            } catch(e) { console.error('Error:', e); }
        }

        function deleteIdea(ideaId) {
            const isAdmin = currentUser && ADMIN_USERNAMES.includes(currentUser.username);
            if (!isAdmin) return;
            
            tg.showPopup({
                title: 'Удалить идею?',
                message: 'Восстановить нельзя',
                buttons: [
                    {type: 'destructive', text: 'Удалить', id: 'delete'},
                    {type: 'cancel', text: 'Отмена', id: 'cancel'}
                ]
            }, async (btnId) => {
                if (btnId === 'delete') {
                    try {
                        await db.collection('ideas').doc(ideaId).delete();
                        tg.showPopup({title:'Успешно',message:'Идея удалена',buttons:[{type:'ok',text:'Ок'}]});
                    } catch(e) { console.error('Error:', e); }
                }
            });
        }

        function openAddIdeaModal() {
            if (!currentUser) return tg.showPopup({title:'Ошибка',message:'Нужно войти',buttons:[{type:'ok',text:'Понятно'}]});
            tg.HapticFeedback.impactOccurred('light');
            document.getElementById('addIdeaModal').classList.add('active');
            document.getElementById('ideaTitle').value = '';
            document.getElementById('ideaContent').value = '';
            document.getElementById('titleCharCounter').textContent = '0/15';
        }

        function closeAddIdeaModal() {
            tg.HapticFeedback.impactOccurred('light');
            document.getElementById('addIdeaModal').classList.remove('active');
        }

        async function submitIdea() {
            const title = document.getElementById('ideaTitle').value.trim();
            const content = document.getElementById('ideaContent').value.trim();
            
            if (!title) return tg.showPopup({title:'Ошибка',message:'Название пустое',buttons:[{type:'ok',text:'Понятно'}]});
            if (title.length > 15) return tg.showPopup({title:'Ошибка',message:'Макс 15 символов',buttons:[{type:'ok',text:'Понятно'}]});
            
            try {
                await db.collection('ideas').add({
                    title: title,
                    content: content,
                    author: currentUser.first_name || 'Аноним',
                    userId: currentUser.id.toString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeAddIdeaModal();
                tg.showPopup({title:'Успешно!',message:'Идея добавлена',buttons:[{type:'ok',text:'Круто'}]});
            } catch(e) { console.error('Error:', e); }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
